import os
from dotenv import load_dotenv
import google.generativeai as genai

load_dotenv()  # Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ Ù…Ø­ÛŒØ·ÛŒ Ø§Ø² ÙØ§ÛŒÙ„ .env

# Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù„ÛŒØ¯ API Ø¨Ù‡ ØµÙˆØ±Øª Ø³Ø±Ø§Ø³Ø±ÛŒ
GEMINI_API_KEY = os.getenv("GEMINI_API_KEY")
model = None # ØªØ¹Ø±ÛŒÙ Ø§ÙˆÙ„ÛŒÙ‡ Ù…Ø¯Ù„
SETUP_ERROR = None # Ù…ØªØºÛŒØ± Ø¬Ø¯ÛŒØ¯ Ø¨Ø±Ø§ÛŒ Ù†Ú¯Ù‡Ø¯Ø§Ø±ÛŒ Ù¾ÛŒØ§Ù… Ø®Ø·Ø§ÛŒ ØªÙ†Ø¸ÛŒÙ…Ø§Øª

if not GEMINI_API_KEY:
    print("âš ï¸ Ø®Ø·Ø§: Ù…ØªØºÛŒØ± Ù…Ø­ÛŒØ·ÛŒ GEMINI_API_KEY ØªÙ†Ø¸ÛŒÙ… Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª!")
    SETUP_ERROR = "Ú©Ù„ÛŒØ¯ API (GEMINI_API_KEY) Ø¯Ø± ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ù…Ø­ÛŒØ·ÛŒ (Ù…Ø«Ù„ .env) ÛŒØ§ÙØª Ù†Ø´Ø¯."
else:
    try:
        # ØªÙ†Ø¸ÛŒÙ… Ú©Ù„Ø§ÛŒÙ†Øª Gemini
        genai.configure(api_key=GEMINI_API_KEY)

        # Ø³Ø§Ø®Øª Ù…Ø¯Ù„ Ø¨Ø§ Ø¯Ø³ØªÙˆØ±Ø§Ù„Ø¹Ù…Ù„ Ø¯Ù‚ÛŒÙ‚
        model = genai.GenerativeModel(
            'gemini-2.5-flash',
            system_instruction="""ØªÙˆ ÛŒÚ© Ø¯Ø³ØªÛŒØ§Ø± Ù‡ÙˆØ´Ù…Ù†Ø¯ Ùˆ Ø¯Ù„Ø³ÙˆØ² Ø¯Ø§Ù†Ø´Ø¬ÙˆÛŒØ§Ù† Ù‡Ø³ØªÛŒ Ú©Ù‡ Ø¨Ù‡ Ø²Ø¨Ø§Ù† ÙØ§Ø±Ø³ÛŒ Ù¾Ø§Ø³Ø® Ù…ÛŒâ€ŒØ¯Ù‡ÛŒ.
ÙˆØ¸ÛŒÙÙ‡ Ø§ØµÙ„ÛŒ ØªÙˆ Ù¾Ø§Ø³Ø® Ø¯Ø§Ø¯Ù† Ø¨Ù‡ Ø³ÙˆØ§Ù„Ø§Øª Ø¯Ø±Ø³ÛŒØŒ Ù¾Ø±ÙˆÚ˜Ù‡â€ŒØ§ÛŒØŒ Ø¨Ø±Ù†Ø§Ù…Ù‡â€ŒÙ†ÙˆÛŒØ³ÛŒ Ùˆ Ø§Ø±Ø§Ø¦Ù‡ Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒÛŒâ€ŒÙ‡Ø§ÛŒ ØªØ­ØµÛŒÙ„ÛŒ Ø§Ø³Øª.

Ù‚ÙˆØ§Ø¹Ø¯ Ù¾Ø§Ø³Ø®Ú¯ÙˆÛŒÛŒ Ù…Ù‡Ù…:
1.  **Ù¾Ø§Ø³Ø® Ø¨Ù‡ Ø³ÙˆØ§Ù„Ø§Øª Ø¯Ø±Ø³ÛŒ:** Ù‡Ù…ÛŒØ´Ù‡ Ù¾Ø§Ø³Ø®ÛŒ Ø¬Ø§Ù…Ø¹ØŒ Ø¯Ù‚ÛŒÙ‚ Ùˆ Ù…ØªÙ†Ø§Ø³Ø¨ Ø¨Ø§ Ø³Ø·Ø­ Ø¯Ø§Ù†Ø´Ú¯Ø§Ù‡ÛŒ Ø§Ø±Ø§Ø¦Ù‡ Ø¨Ø¯Ù‡.
2.  **Ù¾Ø§Ø³Ø® Ø¨Ù‡ Ø³ÙˆØ§Ù„Ø§Øª Ø³Ø§Ø²Ù†Ø¯Ù‡:** Ø§Ú¯Ø± Ú©Ø§Ø±Ø¨Ø± Ø¯Ø± Ù…ÙˆØ±Ø¯ Â«Ø³Ø§Ø²Ù†Ø¯Ù‡Â»ØŒ Â«ØªÙˆØ³Ø¹Ù‡â€ŒØ¯Ù‡Ù†Ø¯Ù‡Â»ØŒ Â«Ù†ÙˆÛŒØ³Ù†Ø¯Ù‡Â» ÛŒØ§ Â«Ú†Ù‡ Ú©Ø³ÛŒ ØªÙˆ Ø±Ø§ Ø³Ø§Ø®ØªÙ‡Â» Ù¾Ø±Ø³ÛŒØ¯ØŒ Ø¯Ù‚ÛŒÙ‚Ø§Ù‹ Ø§ÛŒÙ† Ù…ØªÙ† Ø±Ø§ Ø¨Ù‡ Ø§Ùˆ Ø¨Ú¯Ùˆ:
    Â«Ù…Ù† ØªÙˆØ³Ø· **Ù…Ø­Ù…Ø¯Ø­Ø³ÛŒÙ† ØªØ§Ø¬ÛŒÚ©** Ø¨Ø§ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ Ú¯ÙˆÚ¯Ù„ (Gemini) ØªÙˆØ³Ø¹Ù‡ Ø¯Ø§Ø¯Ù‡ Ø´Ø¯Ù‡â€ŒØ§Ù…. Ù‡Ø¯Ù Ù…Ù† Ú©Ù…Ú© Ø¨Ù‡ Ø±Ø´Ø¯ ØªØ­ØµÛŒÙ„ÛŒ Ø´Ù…Ø§Ø³Øª. Ù…ÛŒâ€ŒØªÙˆÙ†ÛŒ Ù…Ø­Ù…Ø¯Ø­Ø³ÛŒÙ† Ø±Ùˆ Ø¯Ø± Ø§ÛŒÙ†Ø³ØªØ§Ú¯Ø±Ø§Ù… Ø¯Ù†Ø¨Ø§Ù„ Ú©Ù†ÛŒ: https://www.instagram.com/mohmels/Â»
"""
        )
    except Exception as e:
        print(f"âš ï¸ Ø®Ø·Ø§ Ø¯Ø± ØªÙ†Ø¸ÛŒÙ… Gemini API: {str(e)}")
        SETUP_ERROR = f"Ø®Ø·Ø§ Ø¯Ø± ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø§ÙˆÙ„ÛŒÙ‡ Ù…Ø¯Ù„: {str(e)}"

def get_reply_user(user_text: str) -> str:
    """
    Ø§ÛŒÙ† ØªØ§Ø¨Ø¹ Ù…ØªÙ† Ú©Ø§Ø±Ø¨Ø± Ø±Ùˆ Ù…ÛŒâ€ŒÚ¯ÛŒØ±Ù‡ Ùˆ Ø§Ø² Google Gemini Ù¾Ø§Ø³Ø® ÙˆØ§Ù‚Ø¹ÛŒ Ù…ÛŒâ€ŒÚ¯ÛŒØ±Ù‡.
    """
    # Ø¨Ø±Ø±Ø³ÛŒ Ù…Ø¯Ù„ Ù‚Ø¨Ù„ Ø§Ø² Ø§Ø³ØªÙØ§Ø¯Ù‡
    if model is None:
        detailed_error = SETUP_ERROR if SETUP_ERROR else "Ø®Ø·Ø§ÛŒ Ù†Ø§Ù…Ø´Ø®Øµ Ø¯Ø± ØªÙ†Ø¸ÛŒÙ…Ø§Øª."
        return f"âš ï¸ Ø®Ø·Ø§ÛŒ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø¨Ú©â€ŒØ§Ù†Ø¯: {detailed_error} Ù„Ø·ÙØ§Ù‹ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ù¾ÛŒÚ©Ø±Ø¨Ù†Ø¯ÛŒ Ùˆ Ú©Ù„ÛŒØ¯ API Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯."

    try:
        # ğŸŸ¢ Ù†Ø³Ø®Ù‡ ØµØ­ÛŒØ­ Ø¨Ø¯ÙˆÙ† Ø§Ø¨Ø²Ø§Ø± Ø¬Ø³ØªØ¬Ùˆ
        response = model.generate_content(user_text) 
        
        # Ø¨Ø±Ø±Ø³ÛŒ Ù…Ø­ØªÙˆØ§ÛŒ Ù¾Ø§Ø³Ø®
        if response.candidates and response.candidates[0].finish_reason.name == 'SAFETY':
             return "âš ï¸ Ø¨Ù‡ Ø¯Ù„ÛŒÙ„ Ø®Ø·â€ŒÙ…Ø´ÛŒâ€ŒÙ‡Ø§ÛŒ Ø§ÛŒÙ…Ù†ÛŒØŒ Ø§Ù…Ú©Ø§Ù† Ù¾Ø§Ø³Ø®Ú¯ÙˆÛŒÛŒ Ø¨Ù‡ Ø§ÛŒÙ† Ø³ÙˆØ§Ù„ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯."
        
        return response.text.strip()
    
    except Exception as e:
        return f"Ø®Ø·Ø§ Ø¯Ø± Ú¯Ø±ÙØªÙ† Ù¾Ø§Ø³Ø® Ø§Ø² Gemini: {str(e)}"